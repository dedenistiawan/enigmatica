<!DOCTYPE html>
<html lang="en" dir="ltr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=4321&amp;path=livereload" data-no-instant defer></script>
  
                           
     


<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.126.1">
<title>Take a Sad Script &amp; Make it Better: Tidymodels Edition | Alison Hill, PhD</title>


<meta property="twitter:site" content="@apreshill">
<meta property="twitter:creator" content="@apreshill">







  
    
  
<meta name="description" content="Inside you&#39;ll find my writing about products and projects I&#39;ve work on, along with my personal reflections about learning, teaching, and crafting kind tech tools.">


<meta property="og:site_name" content="Alison Hill, PhD">
<meta property="og:title" content="Take a Sad Script &amp; Make it Better: Tidymodels Edition | Alison Hill, PhD">
<meta property="og:description" content="Inside you&#39;ll find my writing about products and projects I&#39;ve work on, along with my personal reflections about learning, teaching, and crafting kind tech tools." />
<meta property="og:type" content="page" />
<meta property="og:url" content="http://localhost:4321/blog/2020-02-take-a-sad-script-make-it-better-tidymodels-edition/" />
<meta property="og:locale" content="en">




    
        <meta property="og:image" content="http://localhost:4321/blog/2020-02-take-a-sad-script-make-it-better-tidymodels-edition/featured.jpg" >
        <meta property="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="http://localhost:4321/blog/2020-02-take-a-sad-script-make-it-better-tidymodels-edition/featured.jpg" >
    
    
  
  <meta itemprop="name" content="Take a Sad Script &amp; Make it Better: Tidymodels Edition">
  <meta itemprop="description" content="Taking a sad script and making it better for model cross-validation.">
  <meta itemprop="datePublished" content="2020-02-27T00:00:00+00:00">
  <meta itemprop="dateModified" content="2020-02-27T00:00:00+00:00">
  <meta itemprop="wordCount" content="3839">
  <meta itemprop="image" content="http://localhost:4321/blog/2020-02-take-a-sad-script-make-it-better-tidymodels-edition/featured.jpg">
  <meta itemprop="keywords" content="Tidymodels">
  
  


  <!--[if IE]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  
  
  <link rel="stylesheet" href="/style.main.min.6041db9742a65e35bbf4deca356e7c1ea7aca5585ac63be9b81a26a5904c8540.css" integrity="sha256-YEHbl0KmXjW79N7KNW58HqespVhaxjvpuBompZBMhUA=" media="screen">
  
  
  <script src="/panelset.min.ed1ac24b6e16f4e2481e3d1d098ae66f5bc77438aef619e6e266d8ac5b00dc72.js" type="text/javascript"></script>
  
  
  <script src="/main.min.b44d2e2e796cd9f2dd491e942e73c70ef631d82d2eb9c52c6ac45a1dbf16a403.js" type="text/javascript"></script>
  
  <script data-goatcounter="https://alison.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</head>
<body>
      <div class="grid-container">
<header class="site-header pt4 pb2 mb4 bb b--transparent ph5 headroom z-max" role="banner">
  <nav class="site-nav db dt-l w-100" role="navigation">
    <a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href="http://localhost:4321/" title="Home">
      <img src="/img/penguin.png" class="dib db-l h2 w-auto" alt="Alison Hill, PhD">
    </a>
    <div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l ttu tracked">
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/about/" title="About Alison Hill">About</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 active" href="/blog/" title="Blog">Blog</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/project/" title="Project Portfolio">Projects</a>
      
        
        
        
      <a class="link f6 f5-l dib pv1 ph2 " href="/talk/" title="Talks">Talks</a>
      
      
    </div>
  </nav>
</header>

<main class="page-main pa4" role="main">
  <section class="page-content mw7 center">
    <article class="post-content pa0 ph4-l">
      <header class="post-header">
        <h1 class="f1 lh-solid measure-narrow mb3 fw4">Take a Sad Script &amp; Make it Better: Tidymodels Edition</h1>
        
        <p class="f6 measure lh-copy mv1">By Alison Hill in <a href="http://localhost:4321/categories/machine-learning">machine learning</a>  <a href="http://localhost:4321/categories/tidymodels">tidymodels</a> </p>
        <p class="f7 db mv0 ttu">February 27, 2020</p>

      

      </header>
      <section class="post-body pt5 pb4">
        <p>A few years ago, I did a talk called 
<a href="/talk/2018-ohsu-sad-plot-better/">&ldquo;Take a Sad Plot &amp; Make it Better,&rdquo;</a> where I showed how I took a single sad plot and tried to make it better. The process of making that plot better taught me a lot about data visualization, and about the 
<a href="https://ggplot2.tidyverse.org/" target="_blank" rel="noopener">ggplot2 package</a>.</p>
<p>Fast-forward to 2019 when I started learning 
<a href="https://github.com/tidymodels/" target="_blank" rel="noopener">tidymodels</a>, and I have accumulated some pretty sad predictive modeling scripts! And my sad plots are not so lonely anymore. Specifically, my old scripts for doing cross-validation with tidymodels are particularly sad. But, I&rsquo;ve been able to make them better (one might even call them happy), primarily due to changes in the 
<a href="https://tidymodels.github.io/tune/" target="_blank" rel="noopener">tune package</a> and the addition of the <code>fit_resamples()</code> function. The process of making these scripts better taught me a lot about predictive modeling, and about the (evolving) tidymodels ecosystem. So, why write a blog post with outdated code?</p>
<ol>
<li>I want to remember <em>that</em> I did this &ldquo;by hand.&rdquo;</li>
<li>I want to remember <em>how</em> I did this &ldquo;by hand.&rdquo; The code still works, even if there is now a happier path to doing the same thing.</li>
<li>I want to share cute penguin art and gifs.</li>
</ol>
<p>Let&rsquo;s start with some 
<a href="http://www.greenhumour.com/2018/04/penguins-of-world.html" target="_blank" rel="noopener">cute penguin art</a> by Rohan Chakravarty&hellip;</p>
<p><a href="http://www.greenhumour.com/2018/04/penguins-of-world.html" target="_blank"><img src="penguins-of-the-world.JPG" width="270" style="display: block; margin: auto;" /></a></p>
<p>My objective here is <strong>not</strong> to provide an introduction to using tidymodels, cross-validation, or to machine learning. If that is what you came for, check out the project button at the top of this post for my workshop materials for learners, and my 
<a href="https://education.rstudio.com/blog/2020/02/conf20-intro-ml/" target="_blank" rel="noopener">associated blog post</a> on the RStudio education site.</p>
<div class="alert alert-note">
  <div>
    <strong>Bottom line:</strong> If you are stumbling upon this blog post in the year 2020 or beyond, know that there is a better way!
  </div>
</div>




<h2 id="a-sad-script-symphony---">A sad script symphony 🎻 🎷 🎹
  <a href="#a-sad-script-symphony---"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>I&rsquo;m not the first person to write sad tidymodels scripts- there are many out in the wild. Here were the blog posts that I found most helpful when trying to solve this particular coding conundrum:</p>
<ol>
<li>
<p>
<a href="https://towardsdatascience.com/modelling-with-tidymodels-and-parsnip-bae2c01c131c" target="_blank" rel="noopener">Modelling with Tidymodels and Parsnip: A Tidy Approach to a Classification Problem</a> by Diego Usai</p>
</li>
<li>
<p>
<a href="https://www.brodrigues.co/blog/2018-11-25-tidy_cv/" target="_blank" rel="noopener">A tutorial on tidy cross-validation with R</a> by Bruno Rodrigues</p>
</li>
<li>
<p>
<a href="https://www.benjaminsorensen.me/post/modeling-with-parsnip-and-tidymodels/" target="_blank" rel="noopener">Modeling with parsnip and tidymodels</a> by Benjamin Sorensen</p>
</li>
</ol>




<h2 id="packages">Packages
  <a href="#packages"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(tidyverse)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(tidymodels)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(rpart)  <span style="color:#998;font-style:italic"># for decision tree</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(ranger) <span style="color:#998;font-style:italic"># for random forest</span>
</span></span></code></pre></div>



<h2 id="data">Data
  <a href="#data"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>I&rsquo;m going to use data that Allison Horst helped me source on penguins from the 
<a href="https://en.wikipedia.org/wiki/Palmer_Station" target="_blank" rel="noopener">Palmer Station</a> (Antarctica) 
<a href="https://lternet.edu/" target="_blank" rel="noopener">Long Term Ecological Research Network</a>.</p>
<blockquote>
<p>&ldquo;sooo now I&rsquo;m just looking at penguin pictures&rdquo;</p>
<ul>
<li>
<a href="https://twitter.com/allison_horst?lang=en" target="_blank" rel="noopener">Allison Horst</a> after slacking me this penguin data</li>
</ul>
</blockquote>
<div class="alert alert-note">
  <div>
    <strong>Update!</strong> We have bundled the Palmer Station penguins data into an R data package named palmerpenguins. Enjoy &#x1f427; Here is the package website: 
<a href="https://allisonhorst.github.io/palmerpenguins/" target="_blank" rel="noopener">https://allisonhorst.github.io/palmerpenguins/</a>
  </div>
</div>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">install.packages</span>(<span style="color:#d14">&#34;remotes&#34;</span>) <span style="color:#998;font-style:italic"># to install from github</span>
</span></span><span style="display:flex;"><span>remotes<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">install_github</span>(<span style="color:#d14">&#34;allisonhorst/palmerpenguins&#34;</span>)
</span></span></code></pre></div><p><img src="https://allisonhorst.github.io/palmerpenguins/reference/figures/logo.png" alt=""></p>
<p>After you&rsquo;ve installed the package, load it and read about the variables with <code>?penguins</code>. We&rsquo;ll modify this dataset lightly by:</p>
<ul>
<li>casting all characters as factors,</li>
<li>dropping any observations with missing data, and</li>
<li>dropping the <code>island</code> variable.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">library</span>(palmerpenguins)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tidypenguins <span style="color:#000;font-weight:bold">&lt;-</span> penguins <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">select</span>(<span style="color:#000;font-weight:bold">-</span>island) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">drop_na</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">glimpse</span>(tidypenguins)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Rows: 333</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Columns: 7</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ species           &lt;fct&gt; Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Ade…</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ bill_length_mm    &lt;dbl&gt; 39.1, 39.5, 40.3, 36.7, 39.3, 38.9, 39.2, 41.1, 38.…</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ bill_depth_mm     &lt;dbl&gt; 18.7, 17.4, 18.0, 19.3, 20.6, 17.8, 19.6, 17.6, 21.…</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ flipper_length_mm &lt;int&gt; 181, 186, 195, 193, 190, 181, 195, 182, 191, 198, 1…</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ body_mass_g       &lt;int&gt; 3750, 3800, 3250, 3450, 3650, 3625, 4675, 3200, 380…</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ sex               &lt;fct&gt; male, female, female, female, male, female, male, f…</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; $ year              &lt;int&gt; 2007, 2007, 2007, 2007, 2007, 2007, 2007, 2007, 200…</span>
</span></span></code></pre></div>



<h2 id="penguins">Penguins
  <a href="#penguins"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<div class="figure">
<img src="https://allisonhorst.github.io/palmerpenguins/man/figures/lter_penguins.png" alt="Artwork by @allisonhorst" width="50%" />
<p class="caption">Figure 1: Artwork by @allisonhorst</p>
</div>
<p>This data included structural size measurements of penguins like their bill length, flipper length, and body mass. It also included each penguin&rsquo;s species and sex. I&rsquo;m going to use this data to try to predict penguin body mass. Sadly, we only have data for three distinct penguin species:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>tidypenguins <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">count</span>(species)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 3 x 2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   species       n</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;fct&gt;     &lt;int&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 Adelie      146</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 2 Chinstrap    68</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 3 Gentoo      119</span>
</span></span></code></pre></div><p>Here is a lineup:</p>
<img src="https://www.bas.ac.uk/wp-content/uploads/2015/04/Penguin-heights.jpg" style="display: block; margin: auto;" />
<p>From: 
<a href="https://www.bas.ac.uk/about/antarctica/wildlife/penguins/" target="_blank" rel="noopener">https://www.bas.ac.uk/about/antarctica/wildlife/penguins/</a></p>
<p>Looks like we have data for 3 of the smaller penguin species (of those pictured here).</p>
<p>First, let&rsquo;s build a simple linear regression model to predict body mass from flipper length.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">ggplot</span>(tidypenguins, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> flipper_length_mm, y <span style="color:#000;font-weight:bold">=</span> body_mass_g)) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">geom_point</span>(color <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;salmon&#34;</span>, size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">.9</span>) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">geom_smooth</span>(method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;lm&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">theme_penguin</span>()
</span></span></code></pre></div><img src="figs/unnamed-chunk-9-1.png" width="672" />
<p>Not bad! Looks promising. To actually fit a linear regression model, you might be used to something like this in R:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_mod <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">lm</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> flipper_length_mm, data <span style="color:#000;font-weight:bold">=</span> tidypenguins)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">summary</span>(penguin_mod)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Call:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; lm(formula = body_mass_g ~ flipper_length_mm, data = tidypenguins)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Residuals:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;      Min       1Q   Median       3Q      Max </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; -1057.33  -259.79   -12.24   242.97  1293.89 </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Coefficients:</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;                   Estimate Std. Error t value Pr(&gt;|t|)    </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; (Intercept)       -5872.09     310.29  -18.93   &lt;2e-16 ***</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; flipper_length_mm    50.15       1.54   32.56   &lt;2e-16 ***</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; ---</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Residual standard error: 393.3 on 331 degrees of freedom</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Multiple R-squared:  0.7621,	Adjusted R-squared:  0.7614 </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; F-statistic:  1060 on 1 and 331 DF,  p-value: &lt; 2.2e-16</span>
</span></span></code></pre></div><p>But we aren&rsquo;t going to stick with this. We are going to use tidymodels, with the goal of generating accurate predictions for future, yet-to-be-seen penguins.</p>
<p><img src="https://media.giphy.com/media/C0EYVrLCgnYdy/giphy.gif" alt=""></p>




<h2 id="tidymodels-101">tidymodels 101
  <a href="#tidymodels-101"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>The code provided in the section below is <em>not</em> particularly sad 🐧. If you are embarking on learning tidymodels, you&rsquo;ll need to use this same kind of code as the building blocks for any predictive modeling pipeline.</p>




<h3 id="parsnip-build-the-model">Parsnip: build the model
  <a href="#parsnip-build-the-model"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>This step is really three, using only the 
<a href="https://tidymodels.github.io/parsnip/" target="_blank" rel="noopener">parsnip package</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>lm_spec <span style="color:#000;font-weight:bold">&lt;-</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">linear_reg</span>() <span style="color:#000;font-weight:bold">%&gt;%</span>       <span style="color:#998;font-style:italic"># pick model</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">set_engine</span>(<span style="color:#d14">&#34;lm&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span>   <span style="color:#998;font-style:italic"># set engine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">set_mode</span>(<span style="color:#d14">&#34;regression&#34;</span>) <span style="color:#998;font-style:italic"># set mode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lm_spec
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Linear Regression Model Specification (regression)</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; Computational engine: lm</span>
</span></span></code></pre></div><p>Things that are missing: data (we haven&rsquo;t touched it yet) and a formula (no data, no variables, no twiddle <code>~</code>). This is an <em>abstract</em> model specification. See other possible parsnip models 
<a href="https://tidymodels.github.io/parsnip/articles/articles/Models.html" target="_blank" rel="noopener">here</a>.</p>




<h3 id="recipe-not-happening-here-folks">Recipe: not happening here, folks
  <a href="#recipe-not-happening-here-folks"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>This is where you would normally insert some code for feature engineering using the 
<a href="https://tidymodels.github.io/recipes/" target="_blank" rel="noopener">recipes package</a>. But previously this required functions named <code>prep()</code>, <code>bake()</code>, <code>juice()</code>- so I&rsquo;m willfully ignoring that for now. There will be no recipes involving penguins.</p>
<p><img src="https://media.giphy.com/media/H4uE6w9G1uK4M/giphy.gif" alt=""></p>




<h3 id="rsample-initial-split">Rsample: initial split
  <a href="#rsample-initial-split"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>We&rsquo;ll use the 
<a href="https://tidymodels.github.io/rsample/" target="_blank" rel="noopener">rsample package</a> to split (<em>ayee! I promise no penguins were hurt in the writing of this blog post</em>) the penguins up into two datasets: training and testing. If you are unfamiliar with this practice, read up on 
<a href="https://sebastianraschka.com/blog/2016/model-evaluation-selection-part1.html#resubstitution-validation-and-the-holdout-method" target="_blank" rel="noopener">the holdout method</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_split <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">initial_split</span>(tidypenguins, strata <span style="color:#000;font-weight:bold">=</span> species)
</span></span><span style="display:flex;"><span>penguin_train <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">training</span>(penguin_split)
</span></span><span style="display:flex;"><span>penguin_test  <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">testing</span>(penguin_split)
</span></span></code></pre></div>



<h3 id="fitting-the-model-once">Fitting the model once
  <a href="#fitting-the-model-once"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>Fitting a single model once is&hellip;not <em>exactly</em> the hardest part.</p>
<p><img src="https://media.giphy.com/media/4KALRmOb8uwbC/giphy.gif" alt=""></p>
<p>This is essentially the workflow from this 
<a href="https://rviews.rstudio.com/2019/06/19/a-gentle-intro-to-tidymodels/" target="_blank" rel="noopener">early blog post</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lm_spec <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># train: get fitted model</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">fit</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> ., data <span style="color:#000;font-weight:bold">=</span> penguin_train) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># test: get predictions</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">predict</span>(new_data <span style="color:#000;font-weight:bold">=</span> penguin_test) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># compare: get metrics</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">bind_cols</span>(penguin_test) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">rmse</span>(truth <span style="color:#000;font-weight:bold">=</span> body_mass_g, estimate <span style="color:#000;font-weight:bold">=</span> .pred)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   .metric .estimator .estimate</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 rmse    standard        278.</span>
</span></span></code></pre></div>



<h3 id="fitting-the-model-with-a-function">Fitting the model with a function
  <a href="#fitting-the-model-with-a-function"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>If you squint, you might see that I could make this into a function like below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>get_rmse <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(model_spec, split) {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  model_spec <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># train: get fitted model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">fit</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> ., data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">training</span>(split)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># test: get predictions</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">predict</span>(new_data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">testing</span>(split)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># compare: get metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">bind_cols</span>(<span style="color:#900;font-weight:bold">testing</span>(split)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">rmse</span>(truth <span style="color:#000;font-weight:bold">=</span> body_mass_g, estimate <span style="color:#000;font-weight:bold">=</span> .pred)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And I could use it to fit a linear regression model:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">get_rmse</span>(model_spec <span style="color:#000;font-weight:bold">=</span> lm_spec, split <span style="color:#000;font-weight:bold">=</span> penguin_split)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   .metric .estimator .estimate</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 rmse    standard        278.</span>
</span></span></code></pre></div><p>I could also build up a tibble that includes the results, if I wanted to save the predicted values, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>get_preds <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(model_spec, split){
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># train: get fitted model</span>
</span></span><span style="display:flex;"><span>  fit_model <span style="color:#000;font-weight:bold">&lt;-</span> model_spec <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">fit</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> ., data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">training</span>(split))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># test: get predictions</span>
</span></span><span style="display:flex;"><span>  preds <span style="color:#000;font-weight:bold">&lt;-</span> fit_model <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">predict</span>(new_data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">testing</span>(split)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">bind_cols</span>(<span style="color:#900;font-weight:bold">testing</span>(split) <span style="color:#000;font-weight:bold">%&gt;%</span> <span style="color:#900;font-weight:bold">select</span>(body_mass_g, species))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  preds
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>penguin_preds <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">get_preds</span>(model_spec <span style="color:#000;font-weight:bold">=</span> lm_spec, split <span style="color:#000;font-weight:bold">=</span> penguin_split)
</span></span></code></pre></div><p>Then I can work with the predicted values, like plotting the fitted body mass estimates against the residuals.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">ggplot</span>(penguin_preds, <span style="color:#900;font-weight:bold">aes</span>(x <span style="color:#000;font-weight:bold">=</span> .pred, y <span style="color:#000;font-weight:bold">=</span> (.pred <span style="color:#000;font-weight:bold">-</span> body_mass_g))) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">geom_point</span>(<span style="color:#900;font-weight:bold">aes</span>(colour <span style="color:#000;font-weight:bold">=</span> species), size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">3</span>, alpha <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">.8</span>) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">geom_smooth</span>(method <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;lm&#34;</span>) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">theme_penguin</span>() <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  scico<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">scale_colour_scico_d</span>(end <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">.8</span>) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">ggtitle</span>(<span style="color:#d14">&#34;Residuals vs Fitted&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; `geom_smooth()` using formula &#39;y ~ x&#39;</span>
</span></span></code></pre></div><img src="figs/unnamed-chunk-17-1.png" width="672" />
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># compare: get metrics</span>
</span></span><span style="display:flex;"><span>penguin_preds <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">rmse</span>(truth <span style="color:#000;font-weight:bold">=</span> body_mass_g, estimate <span style="color:#000;font-weight:bold">=</span> .pred)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   .metric .estimator .estimate</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 rmse    standard        278.</span>
</span></span></code></pre></div><p>Or I could fit a regression tree model with a new model spec:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># regression tree model spec</span>
</span></span><span style="display:flex;"><span>rt_spec <span style="color:#000;font-weight:bold">&lt;-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">decision_tree</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">set_engine</span>(<span style="color:#d14">&#34;rpart&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">set_mode</span>(<span style="color:#d14">&#34;regression&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># get rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">get_preds</span>(model_spec <span style="color:#000;font-weight:bold">=</span> rt_spec, 
</span></span><span style="display:flex;"><span>          split <span style="color:#000;font-weight:bold">=</span> penguin_split) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">rmse</span>(truth <span style="color:#000;font-weight:bold">=</span> body_mass_g, estimate <span style="color:#000;font-weight:bold">=</span> .pred)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   .metric .estimator .estimate</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 rmse    standard        312.</span>
</span></span></code></pre></div><p>Or a random forest:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># random forest model spec</span>
</span></span><span style="display:flex;"><span>rf_spec <span style="color:#000;font-weight:bold">&lt;-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">rand_forest</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">set_engine</span>(<span style="color:#d14">&#34;ranger&#34;</span>) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">set_mode</span>(<span style="color:#d14">&#34;regression&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># get rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">get_preds</span>(model_spec <span style="color:#000;font-weight:bold">=</span> rf_spec, 
</span></span><span style="display:flex;"><span>          split <span style="color:#000;font-weight:bold">=</span> penguin_split) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">rmse</span>(truth <span style="color:#000;font-weight:bold">=</span> body_mass_g, estimate <span style="color:#000;font-weight:bold">=</span> .pred)
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   .metric .estimator .estimate</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 rmse    standard        300.</span>
</span></span></code></pre></div><p>But, unfortunately, I shouldn&rsquo;t be predicting with the test set over and over again like this. It isn&rsquo;t good practice to predict with the test set &gt; 1 time. What is a good predictive modeler to do? I should be saving (holding out) the test set and use it to generate predictions exactly once, at the very end — after I&rsquo;ve compared different models, selected my features, and tuned my hyperparameters. How do you do this? You do 
<a href="https://sebastianraschka.com/blog/2016/model-evaluation-selection-part3.html" target="_blank" rel="noopener">cross-validation</a> with the training set, and you leave the testing set for 
<a href="https://tidymodels.github.io/tune/reference/last_fit.html" target="_blank" rel="noopener"><em>the very last fit you do</em></a>.</p>
<p><img src="https://media.giphy.com/media/uwlDAujt3w9mU/giphy.gif" alt=""></p>




<h2 id="hey-jude-dont-make-it-sad-">Hey Jude, don&rsquo;t make it sad 🎶
  <a href="#hey-jude-dont-make-it-sad-"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>Now, for the 😭 part- let&rsquo;s add cross-validation! To do this, we&rsquo;ll use a function called 
<a href="https://tidymodels.github.io/rsample/reference/vfold_cv.html" target="_blank" rel="noopener"><code>rsample::vfold_cv()</code></a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># add the cv step here</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>penguin_folds <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">vfold_cv</span>(data <span style="color:#000;font-weight:bold">=</span> penguin_train, strata <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;species&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>penguin_folds
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; #  10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits           id    </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;           &lt;chr&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225/26]&gt; Fold01</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226/25]&gt; Fold02</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226/25]&gt; Fold03</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226/25]&gt; Fold04</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226/25]&gt; Fold05</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226/25]&gt; Fold06</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226/25]&gt; Fold07</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226/25]&gt; Fold08</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226/25]&gt; Fold09</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226/25]&gt; Fold10</span>
</span></span></code></pre></div><p>The process of training, testing, and computing metrics gets a lot harder when you need to do this across 10 folds, each with a different data split. I eventually worked out three approaches, which I show below. All require some level of comfort with iteration using the 
<a href="https://purrr.tidyverse.org/" target="_blank" rel="noopener">purrr package</a>.</p>




<h3 id="function-with-minimal-purrr-ing">Function with minimal purrr-ing
  <a href="#function-with-minimal-purrr-ing"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>This approach is essentially a mega-function, that we then use purrr to map across each fold.</p>
<p>I&rsquo;m going to change a few things from my previous <code>get_preds()</code> function:</p>
<ol>
<li><code>training(split)</code> -&gt; <code>analysis(split)</code></li>
<li><code>testing(split)</code> -&gt; <code>assessment(split)</code></li>
<li>I also added the <code>rsample::add_resample_id()</code> function to keep track of the fold number.</li>
<li>I saved the predictions now as a list column.</li>
</ol>
<p>To build up this function, my strategy was to figure out how to work with one fold, then I knew I&rsquo;d be able to use <code>purrr::map_df()</code> to apply it across multiple folds.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Figure it out for one fold</span>
</span></span><span style="display:flex;"><span>get_fold_results <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(model_spec, split){
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># train: get fitted model for each fold</span>
</span></span><span style="display:flex;"><span>  fits <span style="color:#000;font-weight:bold">&lt;-</span> model_spec <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">fit</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> ., data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">analysis</span>(split))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># test: get predictions on for each fold</span>
</span></span><span style="display:flex;"><span>  preds <span style="color:#000;font-weight:bold">&lt;-</span> fits <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">predict</span>(new_data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">assessment</span>(split)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">bind_cols</span>(<span style="color:#900;font-weight:bold">assessment</span>(split)) 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># compare: compute metric for each fold</span>
</span></span><span style="display:flex;"><span>  rmse <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#900;font-weight:bold">assessment</span>(split)  <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">summarize</span>(rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">rmse_vec</span>(truth <span style="color:#000;font-weight:bold">=</span> body_mass_g, 
</span></span><span style="display:flex;"><span>                              estimate <span style="color:#000;font-weight:bold">=</span> preds<span style="color:#000;font-weight:bold">$</span>.pred))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  rmse <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># add fold identifier column</span>
</span></span><span style="display:flex;"><span>    rsample<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">add_resample_id</span>(split <span style="color:#000;font-weight:bold">=</span> split) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">as_tibble</span>() <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># add predictions</span>
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">mutate</span>(preds <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">list</span>(preds))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I tried this function with a single fold first:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">get_fold_results</span>(
</span></span><span style="display:flex;"><span>    split      <span style="color:#000;font-weight:bold">=</span> penguin_folds<span style="color:#000;font-weight:bold">$</span>splits[[1]], 
</span></span><span style="display:flex;"><span>    model_spec <span style="color:#000;font-weight:bold">=</span> rt_spec
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    rmse id     preds            </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;list&gt;           </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1  419. Fold01 &lt;tibble [26 × 8]&gt;</span>
</span></span></code></pre></div><p>Next, I used purrr- but just once. The function <code>get_fold_results</code> is doing <strong>most</strong> of the work for us, but I needed purrr to map it across each fold.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>kfold_results <span style="color:#000;font-weight:bold">&lt;-</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">map_df</span>(
</span></span><span style="display:flex;"><span>    penguin_folds<span style="color:#000;font-weight:bold">$</span>splits, 
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">~</span><span style="color:#900;font-weight:bold">get_fold_results</span>(.x, model <span style="color:#000;font-weight:bold">=</span> rt_spec))
</span></span><span style="display:flex;"><span>kfold_results
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;     rmse id     preds            </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;dbl&gt; &lt;chr&gt;  &lt;list&gt;           </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1  419. Fold01 &lt;tibble [26 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2  326. Fold02 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3  414. Fold03 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4  327. Fold04 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5  336. Fold05 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6  406. Fold06 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7  305. Fold07 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8  301. Fold08 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9  315. Fold09 &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10  319. Fold10 &lt;tibble [25 × 8]&gt;</span>
</span></span></code></pre></div><p>Here we are still left with 10 RMSE values- one for each of the 10 folds. We don&rsquo;t care too much about by fold- the power is in the aggregate. Specifically, we mainly care about the central tendency and spread of these RMSE values. Let&rsquo;s finish by combining (or aggregating) these metrics.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>kfold_results <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">summarize</span>(mean_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">mean</span>(rmse), sd_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">sd</span>(rmse))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   mean_rmse sd_rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;       &lt;dbl&gt;   &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1      347.    46.8</span>
</span></span></code></pre></div><p>So, this works. But, can you imagine doing it again? Without errors? Can you imagine teaching it?</p>
<p><img src="https://media.giphy.com/media/bmGmHZ5khMjN6/giphy.gif" alt=""></p>




<h3 id="purrr-to-the-max">Purrr-to-the-max
  <a href="#purrr-to-the-max"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>This approach is <code>purrr::map()</code> (and friends) on steriods. We use vanilla <code>map()</code>, <code>map2()</code>, <em>and</em> <code>map2_dbl()</code> here. We also use 
<a href="https://jennybc.github.io/purrr-tutorial/ls03_map-function-syntax.html#anonymous_function,_formula" target="_blank" rel="noopener">anonymous functions as a formula</a>, <em>and</em> the pipe operator within those anonymous functions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>penguin_res <span style="color:#000;font-weight:bold">&lt;-</span> penguin_folds <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># train: get fitted model for each fold</span>
</span></span><span style="display:flex;"><span>    train_set  <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map</span>(splits, analysis),
</span></span><span style="display:flex;"><span>    fit_models <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map</span>(train_set, <span style="color:#000;font-weight:bold">~</span>rt_spec <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>                                    <span style="color:#900;font-weight:bold">fit</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> ., 
</span></span><span style="display:flex;"><span>                                        data <span style="color:#000;font-weight:bold">=</span> .x)),
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># test: get predictions for each fold</span>
</span></span><span style="display:flex;"><span>    test_set   <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map</span>(splits, assessment),
</span></span><span style="display:flex;"><span>    estimates  <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map2</span>(fit_models, 
</span></span><span style="display:flex;"><span>                      test_set, 
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">~</span>.x <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>                        <span style="color:#900;font-weight:bold">predict</span>(.y)),
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic"># compare: compute metric for each fold</span>
</span></span><span style="display:flex;"><span>    rmse       <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map2_dbl</span>(test_set, 
</span></span><span style="display:flex;"><span>                          estimates, 
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">~</span><span style="color:#900;font-weight:bold">rmse_vec</span>(truth <span style="color:#000;font-weight:bold">=</span> .x<span style="color:#000;font-weight:bold">$</span>body_mass_g, 
</span></span><span style="display:flex;"><span>                                    estimate <span style="color:#000;font-weight:bold">=</span> .y<span style="color:#000;font-weight:bold">$</span>.pred))
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>penguin_res
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; #  10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 7</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits       id     train_set     fit_models test_set     estimates      rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;       &lt;chr&gt;  &lt;list&gt;        &lt;list&gt;     &lt;list&gt;       &lt;list&gt;        &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225… Fold01 &lt;tibble [225… &lt;fit[+]&gt;   &lt;tibble [26… &lt;tibble [26 …  419.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226… Fold02 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  326.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226… Fold03 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  414.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226… Fold04 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  327.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226… Fold05 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  336.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226… Fold06 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  406.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226… Fold07 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  305.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226… Fold08 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  301.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226… Fold09 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  315.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226… Fold10 &lt;tibble [226… &lt;fit[+]&gt;   &lt;tibble [25… &lt;tibble [25 …  319.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>penguin_res <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">summarise</span>(mean_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">mean</span>(rmse), sd_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">sd</span>(rmse))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   mean_rmse sd_rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;       &lt;dbl&gt;   &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1      347.    46.8</span>
</span></span></code></pre></div>



<h3 id="the-purrr-mash-up">The purrr mash-up
  <a href="#the-purrr-mash-up"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h3>
<p>Another way I worked out was largely after reviewing Max&rsquo;s slides from previous workshops. This is basically a mash-up of my previous two approaches, where we write laser-focused functions that each do one thing, then use purrr to apply those functions across the folds. This way is nice(r) for showing in slides as you can incrementally build up the results table. Let&rsquo;s see this sad script in action&hellip;</p>




<h4 id="round-1">Round 1
  <a href="#round-1"></a>
</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>) <span style="color:#998;font-style:italic"># for reproducibility</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># train: get fitted model for a split</span>
</span></span><span style="display:flex;"><span>get_fits <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(split, model_spec){
</span></span><span style="display:flex;"><span>  model_spec <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">fit</span>(body_mass_g <span style="color:#000;font-weight:bold">~</span> ., 
</span></span><span style="display:flex;"><span>        data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">analysis</span>(split))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># train: get fitted models across folds</span>
</span></span><span style="display:flex;"><span>penguin_purrr <span style="color:#000;font-weight:bold">&lt;-</span> penguin_folds <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(rt_fits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map</span>(splits, get_fits, rt_spec))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>penguin_purrr
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; #  10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 3</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits           id     rt_fits </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;           &lt;chr&gt;  &lt;list&gt;  </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225/26]&gt; Fold01 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226/25]&gt; Fold02 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226/25]&gt; Fold03 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226/25]&gt; Fold04 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226/25]&gt; Fold05 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226/25]&gt; Fold06 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226/25]&gt; Fold07 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226/25]&gt; Fold08 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226/25]&gt; Fold09 &lt;fit[+]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226/25]&gt; Fold10 &lt;fit[+]&gt;</span>
</span></span></code></pre></div>



<h4 id="round-2">Round 2
  <a href="#round-2"></a>
</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># test: get predictions for a split</span>
</span></span><span style="display:flex;"><span>get_preds <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(split, fit_df) {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  fit_df <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">predict</span>(new_data <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">assessment</span>(split)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">bind_cols</span>(<span style="color:#900;font-weight:bold">assessment</span>(split))
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># test: get predictions across folds</span>
</span></span><span style="display:flex;"><span>penguin_purrr <span style="color:#000;font-weight:bold">&lt;-</span> penguin_purrr <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(rt_preds <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map2</span>(splits, rt_fits, get_preds))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>penguin_purrr
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; #  10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits           id     rt_fits  rt_preds         </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;           &lt;chr&gt;  &lt;list&gt;   &lt;list&gt;           </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225/26]&gt; Fold01 &lt;fit[+]&gt; &lt;tibble [26 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226/25]&gt; Fold02 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226/25]&gt; Fold03 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226/25]&gt; Fold04 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226/25]&gt; Fold05 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226/25]&gt; Fold06 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226/25]&gt; Fold07 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226/25]&gt; Fold08 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226/25]&gt; Fold09 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226/25]&gt; Fold10 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;</span>
</span></span></code></pre></div>



<h4 id="aaaand-round-3">aaaand Round 3
  <a href="#aaaand-round-3"></a>
</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># compare: compute metric for a split</span>
</span></span><span style="display:flex;"><span>get_rmse <span style="color:#000;font-weight:bold">&lt;-</span> <span style="color:#000;font-weight:bold">function</span>(pred_df) {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  pred_df <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">rmse</span>(truth    <span style="color:#000;font-weight:bold">=</span> body_mass_g, 
</span></span><span style="display:flex;"><span>         estimate <span style="color:#000;font-weight:bold">=</span> .pred) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#900;font-weight:bold">pluck</span>(<span style="color:#d14">&#34;.estimate&#34;</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># compare: compute metric across folds</span>
</span></span><span style="display:flex;"><span>penguin_purrr <span style="color:#000;font-weight:bold">&lt;-</span> penguin_purrr <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(rt_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map_dbl</span>(rt_preds, get_rmse))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>penguin_purrr
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; #  10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits           id     rt_fits  rt_preds          rt_rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;           &lt;chr&gt;  &lt;list&gt;   &lt;list&gt;              &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225/26]&gt; Fold01 &lt;fit[+]&gt; &lt;tibble [26 × 8]&gt;    419.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226/25]&gt; Fold02 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    326.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226/25]&gt; Fold03 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    414.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226/25]&gt; Fold04 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    327.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226/25]&gt; Fold05 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    336.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226/25]&gt; Fold06 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    406.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226/25]&gt; Fold07 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    305.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226/25]&gt; Fold08 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    301.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226/25]&gt; Fold09 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    315.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226/25]&gt; Fold10 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    319.</span>
</span></span></code></pre></div><p>Finally, summarizing as I did before:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_purrr <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">summarize</span>(mean_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">mean</span>(rt_rmse), sd_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">sd</span>(rt_rmse))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 1 x 2</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   mean_rmse sd_rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;       &lt;dbl&gt;   &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1      347.    46.8</span>
</span></span></code></pre></div><p>In practice, if you did all these at once instead of incrementally, it would look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#900;font-weight:bold">set.seed</span>(<span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>penguin_folds <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># train: get fitted model for a split</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(rt_fits <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map</span>(splits, get_fits, rt_spec)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># test: get predictions on for each fold</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(rt_preds <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map2</span>(splits, rt_fits, get_preds)) <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic"># compare: compute metric for each fold</span>
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">mutate</span>(rt_rmse <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">map_dbl</span>(rt_preds, get_rmse))
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; #  10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits           id     rt_fits  rt_preds          rt_rmse</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;           &lt;chr&gt;  &lt;list&gt;   &lt;list&gt;              &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225/26]&gt; Fold01 &lt;fit[+]&gt; &lt;tibble [26 × 8]&gt;    419.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226/25]&gt; Fold02 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    326.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226/25]&gt; Fold03 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    414.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226/25]&gt; Fold04 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    327.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226/25]&gt; Fold05 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    336.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226/25]&gt; Fold06 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    406.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226/25]&gt; Fold07 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    305.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226/25]&gt; Fold08 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    301.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226/25]&gt; Fold09 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    315.</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226/25]&gt; Fold10 &lt;fit[+]&gt; &lt;tibble [25 × 8]&gt;    319.</span>
</span></span></code></pre></div><p>When you put it like <em>that</em>, it doesn&rsquo;t look like so much work! But, this way hides how much work it takes to write those 3 custom functions: <code>get_fits()</code>, <code>get_preds()</code>, and <code>get_rmse()</code>. And we still had to use vanilla <code>map()</code>, <code>map2()</code>, <em>and</em> <code>map2_dbl()</code>.</p>




<h2 id="make-it-better">Make it better
  <a href="#make-it-better"><svg class="anchor-symbol" aria-hidden="true" height="26" width="26" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0h24v24H0z" fill="currentColor"></path>
      <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"></path>
    </svg></a>
</h2>
<p>I kept a learning log while working through the all the above code, and I wrote down these notes to myself:</p>
<ol>
<li>
<p>It is very easy to do the wrong thing; it is very hard to do the right thing.</p>
</li>
<li>
<p>I lost sight many times of what the code I was writing was doing, because I was using up so much cognitive energy on getting the code to just work.</p>
</li>
<li>
<p>I thought I knew how to use purrr&hellip;</p>
</li>
</ol>
<p>If you have made it this far, I&rsquo;m pretty sure I don&rsquo;t need to convince you that a better way to do cross-validation using tidymodels would be more pleasant to do more than once. It would also be less prone to error due to me copying-and-pasting repeatedly, and making stupid mistakes that would be difficult to spot with so much cluttered code. Luckily, 
<a href="https://tidymodels.github.io/tune/reference/fit_resamples.html" target="_blank" rel="noopener"><code>tune::fit_resamples()</code></a> came along to take a sad script and make it better:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_party <span style="color:#000;font-weight:bold">&lt;-</span>
</span></span><span style="display:flex;"><span>  tune<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">fit_resamples</span>(
</span></span><span style="display:flex;"><span>    rt_spec,
</span></span><span style="display:flex;"><span>    body_mass_g <span style="color:#000;font-weight:bold">~</span> .,
</span></span><span style="display:flex;"><span>    resamples <span style="color:#000;font-weight:bold">=</span> penguin_folds
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Here is the beautiful output from that function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_party
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # Resampling results</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # 10-fold cross-validation using stratification </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 10 x 4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    splits           id     .metrics         .notes          </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;list&gt;           &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;          </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 &lt;split [225/26]&gt; Fold01 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 &lt;split [226/25]&gt; Fold02 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 &lt;split [226/25]&gt; Fold03 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 &lt;split [226/25]&gt; Fold04 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 &lt;split [226/25]&gt; Fold05 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 &lt;split [226/25]&gt; Fold06 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 &lt;split [226/25]&gt; Fold07 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 &lt;split [226/25]&gt; Fold08 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 &lt;split [226/25]&gt; Fold09 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 &lt;split [226/25]&gt; Fold10 &lt;tibble [2 × 3]&gt; &lt;tibble [0 × 1]&gt;</span>
</span></span></code></pre></div><p>Now, to see all the stuff inside this <code>penguin_party</code>, we can use tune&rsquo;s <code>collect_*</code> functions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_party <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">collect_metrics</span>()
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 2 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   .metric .estimator    mean     n std_err</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;   &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 1 rmse    standard   347.       10 14.8   </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 2 rsq     standard     0.839    10  0.0141</span>
</span></span></code></pre></div><p>To see the predictions, we need to add use 
<a href="https://tidymodels.github.io/tune/reference/control_grid.html" target="_blank" rel="noopener"><code>control_resamples()</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_party <span style="color:#000;font-weight:bold">&lt;-</span>
</span></span><span style="display:flex;"><span>  tune<span style="color:#000;font-weight:bold">::</span><span style="color:#900;font-weight:bold">fit_resamples</span>(
</span></span><span style="display:flex;"><span>    rt_spec,
</span></span><span style="display:flex;"><span>    body_mass_g <span style="color:#000;font-weight:bold">~</span> .,
</span></span><span style="display:flex;"><span>    resamples <span style="color:#000;font-weight:bold">=</span> penguin_folds,
</span></span><span style="display:flex;"><span>    control <span style="color:#000;font-weight:bold">=</span> <span style="color:#900;font-weight:bold">control_resamples</span>(save_pred <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">TRUE</span>) <span style="color:#998;font-style:italic"># add this line</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Then we collect the predictions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>penguin_party <span style="color:#000;font-weight:bold">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#900;font-weight:bold">collect_predictions</span>()
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # A tibble: 251 x 4</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    id     .pred  .row body_mass_g</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;    &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;       &lt;int&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  1 Fold01 3402.     4        3625</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  2 Fold01 3402.    11        3325</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  3 Fold01 3988.    14        3950</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  4 Fold01 3988.    41        3700</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  5 Fold01 3402.    54        3700</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  6 Fold01 3988.    65        3950</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  7 Fold01 3988.    70        4450</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  8 Fold01 3402.    71        3300</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt;  9 Fold01 3402.    76        3075</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; 10 Fold01 3402.    85        2900</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#&gt; # … with 241 more rows</span>
</span></span></code></pre></div><p>Now, isn&rsquo;t that better?</p>
<p><img src="https://media.giphy.com/media/daeKl3P4SissU/giphy.gif" alt=""><!-- --></p>

        
        <details closed class="f6 fw7 input-reset">
  <dl class="f6 lh-copy">
    <dt class="fw7">Posted on:</dt>
    <dd class="fw5 ml0">February 27, 2020</dd>
  </dl>
  <dl class="f6 lh-copy">
    <dt class="fw7">Length:</dt>
    <dd class="fw5 ml0">19 minute read, 3839 words</dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Categories:</dt>
    <dd class="fw5 ml0"> <a href="http://localhost:4321/categories/machine-learning">machine learning</a>  <a href="http://localhost:4321/categories/tidymodels">tidymodels</a> </dd>
  </dl>
  
  
  
  <dl class="f6 lh-copy">
    <dt class="fw7">Tags:</dt>
    <dd class="fw5 ml0"> <a href="http://localhost:4321/tags/tidymodels">tidymodels</a> </dd>
  </dl>
  
  <dl class="f6 lh-copy">
    <dt class="fw7">See Also:</dt>
    
    <dd class="fw5 ml0"><a href="/talk/2021-tidymodels-it/">Introduction to Machine Learning with Tidymodels</a></dd>
    
    <dd class="fw5 ml0"><a href="/talk/2020-rmedicine-tidyml/">Introduction to Machine Learning with the Tidyverse</a></dd>
    
    <dd class="fw5 ml0"><a href="/project/tidymodels.org/">tidymodels.org</a></dd>
    
  </dl>
</details>

      </section>
      <footer class="post-footer">
        <div class="post-pagination dt w-100 mt4 mb2">
  
  
    <a class="prev dtc pr2 tl v-top fw6"
    href="http://localhost:4321/blog/2020-05-how-i-teach-r-markdown/">&larr; How I Teach R Markdown</a>
  
  
  
    <a class="next dtc pl2 tr v-top fw6"
    href="http://localhost:4321/blog/2019-12-teaching-ml/">Learning to Teach Machines to Learn &rarr;</a>
  
</div>

      </footer>
    </article>
    
      <div class="post-comments pa0 pa4-l mt4">
  
      
        <script src="https://giscus.app/client.js"
            data-repo=rbind/apreshill
            data-repo-id=MDEwOlJlcG9zaXRvcnk5MTAwNTYxNQ&#61;&#61;
            data-category=Comments
            data-category-id=DIC_kwDOBWyir84CfrDg
            data-mapping=pathname
            data-reactions-enabled=1
            data-emit-metadata=0
            data-theme=light_protanopia
            data-lang=en
            crossorigin="anonymous"
            async>
        </script>
      
  
</div>

    
  </section>
</main>
<footer class="site-footer pv4 bt b--transparent ph5" role="contentinfo">
  <nav class="db dt-l w-100">
    <p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">
      &copy; 2025 Alison Hill
      <span class="middot-divider"></span>
      Made with <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/hugo-apero/" rel="dct:source">Hugo Apéro</a></span>.
      <br />
      
Based on <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title"><a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/formspree/blogophonic-hugo" rel="dct:source">Blogophonic</a></span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://formspree.io" property="cc:attributionName" rel="cc:attributionURL">Formspree</a>.
    </p>
    
    <div class="site-social-links db dtc-l v-mid w-100 w-33-l tc pv2 pv0-l mv0">
      <div class="social-icon-links" aria-hidden="true">
  
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://github.com/apreshill" title="github" target="_blank" rel="me noopener">
      <i class="fab fa-github fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://www.linkedin.com/in/apreshill/" title="linkedin-in" target="_blank" rel="me noopener">
      <i class="fab fa-linkedin-in fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://bsky.app/profile/apreshill.com" title="bluesky" target="_blank" rel="me noopener">
      <i class="fab fa-bluesky fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://www.youtube.com/@alisonhill" title="youtube" target="_blank" rel="me noopener">
      <i class="fab fa-youtube fa-lg fa-fw"></i>
    </a>
  
    
    
    
      
    
    
    
    
    
      
    
    <a class="link dib h1 w1 ml0 mr2 f6 o-90 glow" href="https://twitter.com/apreshill" title="x-twitter" target="_blank" rel="me noopener">
      <i class="fab fa-x-twitter fa-lg fa-fw"></i>
    </a>
  
</div>

    </div>
    
    <div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0">
      
      <a class="dib pv1 ph2 link" href="/license/" title="License">License</a>
      
      <a class="dib pv1 ph2 link" href="/contact/" title="Contact form">Contact</a>
      
      <a class="dib pv1 ph2 link" href="/blog/index.xml" title="RSS">RSS</a>
      
    </div>
  </nav>
  
</footer>

      </div>
    </body>
</html>
